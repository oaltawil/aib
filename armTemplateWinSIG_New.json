{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "imageTemplateName": {
            "type": "string"
        },
        "api-version": {
            "type": "string"
        },
        "svclocation": {
            "type": "string"
        }
    },
    
    "variables": {
    },

    "resources": [
        {
            "name": "[parameters('imageTemplateName')]",
            "type": "Microsoft.VirtualMachineImages/imageTemplates",
            "apiVersion": "[parameters('api-version')]",
            "location": "[parameters('svclocation')]",
            "dependsOn": [],
            "tags": {
                "imagebuilderTemplate": "AzureImageBuilderSIG",
                "userIdentity": "enabled"
            },
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "/subscriptions/fb3b34ed-d5da-40c7-8b10-3628d5590ea3/resourcegroups/rg-aibwinsig/providers/Microsoft.ManagedIdentity/userAssignedIdentities/aibIdentity1629042837": {}
                }
            },

            "properties": {
            
                "buildTimeoutInMinutes" : 120,

                "vmProfile": {
                    "vmSize": "Standard_D2s_v4",
                    "osDiskSizeGB": 127
                },

                "source": {
                    "type": "PlatformImage",
                    "publisher": "MicrosoftWindowsDesktop",
                    "offer": "windows-7",
                    "sku": "win7-enterprise",
                    "version": "latest"
                },
            
                "customize": [

                    {
                        "type": "PowerShell",
                        "name": "Create-BuildArtifacts",
                        "inline": [
                            "New-Item -Path C:\\BuildArtifacts\\SecurityUpdates -ItemType Directory -Force",
                            "New-Item -Path C:\\BuildArtifacts\\Applications -ItemType Directory -Force" 
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "WindowsUpdate",
                        "name": "Install-RecommendedUpdates",
                        "searchCriteria": "BrowseOnly=0 and IsInstalled=0",
                        "filters": [
                            "exclude:$false",
                            "include:$true"
                        ],
                        "updateLimit": 20
                    },

                    {
                        "type": "PowerShell",
                        "name": "Enable-TLS1.2",
                        "scriptUri": "https://raw.githubusercontent.com/oaltawil/wvd7/main/Enable-TLS12.ps1",
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "File",
                        "name": "Download-KB2592687-RDP8.0",
                        "sourceUri": "https://download.microsoft.com/download/A/F/5/AF5C565C-9771-4BFB-973B-4094C1F58646/Windows6.1-KB2592687-x64.msu",
                        "destination":"C:\\BuildArtifacts\\SecurityUpdates\\Windows6.1-KB2592687-x64.msu"
                    },

                    {
                        "type": "PowerShell",
                        "name": "Install-KB2592687-RDP8.0",
                        "inline": [
                            "Write-Output 'Installing KB2592687: Update for Remote Desktop Protocol 8.0 for Windows 7 SP1.'",
                            "wusa.exe C:\\BuildArtifacts\\SecurityUpdates\\Windows6.1-KB2592687-x64.msu /quiet /norestart"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "PowerShell",
                        "name": "Enable-RDP8.0",
                        "inline": [
                            "Write-Output 'Enabling Remote Desktop Protocol 8.0.'",
                            "New-Item -Path 'HKLM:SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services' -Force",
                            "Set-ItemProperty -Path 'HKLM:SOFTWARE\\Policies\\Microsoft\\Windows NT\\Terminal Services' -Name fServerEnableRDP8 -Type Dword -Value 1 -Force"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },
                    
                    {
                        "type": "File",
                        "name": "Download-KB3191566-WMF5.1",
                        "sourceUri": "https://download.microsoft.com/download/6/F/5/6F5FF66C-6775-42B0-86C4-47D41F2DA187/Win7AndW2K8R2-KB3191566-x64.zip",
                        "destination":"C:\\BuildArtifacts\\SecurityUpdates\\Win7AndW2K8R2-KB3191566-x64.zip"
                    },

                    {
                        "type": "PowerShell",
                        "name": "Expand-KB3191566-WMF5.1",
                        "inline": [
                            "Write-Output 'Expanding Win7AndW2K8R2-KB3191566-x64.zip.'",
                            "$ZipFilePath = 'C:\\BuildArtifacts\\SecurityUpdates\\Win7AndW2K8R2-KB3191566-x64.zip'",
                            "$DestinationFolderPath = 'C:\\BuildArtifacts\\SecurityUpdates'",
                            "$ShellObject = New-Object -ComObject Shell.Application",
                            "$ZipFileContents = $ShellObject.NameSpace($ZipFilePath).Items()",
                            "$FolderObject = $ShellObject.NameSpace($DestinationFolderPath)",
                            "$FolderObject.CopyHere($ZipFileContents, 20)"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "PowerShell",
                        "name": "Install-KB3191566-WMF5.1",
                        "inline": [
                            "Write-Output 'Installing KB3191566: Windows Management Framework 5.1 for Windows 7 SP1.'",
                            "wusa.exe C:\\BuildArtifacts\\SecurityUpdates\\Win7AndW2K8R2-KB3191566-x64.msu /quiet /norestart"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "File",
                        "name": "Download-FSLogixApps",
                        "sourceUri": "https://aka.ms/fslogix/download",
                        "destination":"C:\\BuildArtifacts\\Applications\\FSLogixApps.zip"
                    },

                    {
                        "type": "PowerShell",
                        "name": "Expand-FSLogixApps",
                        "inline": [
                            "Write-Output 'Expanding Win7AndW2K8R2-KB3191566-x64.zip.'",
                            "$ZipFilePath = 'C:\\BuildArtifacts\\Applications\\FSLogixApps.zip'",
                            "$DestinationFolderPath = 'C:\\BuildArtifacts\\Applications'",
                            "$ShellObject = New-Object -ComObject Shell.Application",
                            "$ZipFileContents = $ShellObject.NameSpace($ZipFilePath).Items()",
                            "$FolderObject = $ShellObject.NameSpace($DestinationFolderPath)",
                            "$FolderObject.CopyHere($ZipFileContents, 20)"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "PowerShell",
                        "name": "Install-FSLogixApps",
                        "inline": [
                            "Write-Output 'Installing FSLogixApps.'",
                            "C:\\BuildArtifacts\\Applications\\x64\\Release\\FSLogixAppsSetup.exe /install /quiet /norestart"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    },

                    {
                        "type": "WindowsRestart",
                        "name": "Restart-Computer-1",
                        "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM  > c:\\BuildArtifacts\\azureImageBuilderRestart.txt",
                        "restartTimeout": "15m"
                    },

                    {
                        "type": "PowerShell",
                        "name": "Verify-InstalledComponents",
                        "inline": [
                            "Write-Output 'Verifying Installed Components and Cleaning up Build Artificats'",
                            "Get-Host",
                            "Get-WmiObject -Class Win32_QuickFixEngineering -Filter \"(HotFixID = 'KB2592687') OR (HotfixID = 'KB3191566')\"",
                            "Get-WmiObject -Class Win32_Product -Filter \"Name = 'Microsoft FSLogix Apps'\"",
                            "Remove-Item -Path C:\\BuildArtifacts -Recurse -Force"
                        ],
                        "runAsSystem": false,
                        "runElevated": true
                    }

                ],
                "distribute": [
                    {   
                        "type": "SharedImage",
                        "galleryImageId": "/subscriptions/fb3b34ed-d5da-40c7-8b10-3628d5590ea3/resourceGroups/rg-aibwinsig/providers/Microsoft.Compute/galleries/scrapaper_SharedImageGallery/images/customWindows7Image",
                        "runOutputName": "build-win7-enterprise",
                        "artifactTags": {
                            "source": "azureVmImageBuilder",
                            "baseosimg": "win7-enterprise"
                        },
                        "replicationRegions": [
                            "eastus",
                            "eastus2"
                        ]
                    }
                ]
            }
        }
    ]
}